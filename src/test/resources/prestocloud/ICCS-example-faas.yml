tosca_definitions_version: tosca_prestocloud_mapping_1_2

metadata:
   template_name: ICCS generated types definition
   template_author: ICCS
   template_version: 1.0.0-SNAPSHOT
   CostThreshold: 1000.0
   TimePeriod:  720
   ProviderName_0: Google_Cloud_Compute
   ProviderRequired_0: false
   ProviderExcluded_0: true
   MaxInstances: 100
   MetricToMinimize: Cost

description: Types Description

imports:
   - tosca-normative-types:1.2
   - iccs-normative-types:1.0
   - resource-descriptions:1.0
   - placement-constraints:1.0

node_types:

   # Requirements for a cloud based proxy
   proxying_fragments_type:
      description: Hosting requirements of a proxy
      derived_from: prestocloud.nodes.proxy.faas
      requirements:
         - host:
            capability: tosca.capabilities.Container
            node: prestocloud.nodes.compute
            relationship: tosca.relationships.HostedOn
            occurrences: [ 1, 1 ]
            node_filter:
               capabilities:
                  - host:
                     properties:
                        - num_cpus: { in_range: [ 1, 2 ] }
                        - mem_size: { in_range: [ 2 GB, 4 GB ] }
                        - disk_size: { in_range: [ 20 GB, 40 GB ] }
                  - resource:
                     properties:
                        - type: { equal: cloud }

   # Audio captor node selection
   processing_node_fragments_AudioCaptor:
      description: A TOSCA description of a node
      derived_from: prestocloud.nodes.agent.faas
      requirements:
         - host:
            capability: tosca.capabilities.Container
            node: prestocloud.nodes.compute
            relationship: tosca.relationships.HostedOn
            occurrences: [ 1,1 ]
            node_filter:
               capabilities:
                  - host:
                     properties:
                        - mem_size: { in_range: [ 200 MB, 4 GB ] }
                        - disk_size: { in_range: [ 20 GB, 40 GB ] }
                  - os:
                     properties:
                        - architecture: { valid_values: [ arm64, armel, armhf ] }
                        - type: { equal: linux }
                        - distribution: { equal: ubuntu }
                  - resource:
                     properties:
                        - type: { valid_values: [ edge ] }
                  - sensors:
                     properties:
                        - microphone: { equal: true }

   # Face detector node selection
   processing_node_fragments_FaceDetector:
      description: A TOSCA description of a node
      derived_from: prestocloud.nodes.agent.faas
      requirements:
         - host:
            capability: tosca.capabilities.Container
            node: prestocloud.nodes.compute
            relationship: tosca.relationships.HostedOn
            occurrences: [ 1,1 ]
            node_filter:
               capabilities:
                  - host:
                     properties:
                        - num_cpus: { in_range: [ 2, 4 ] }
                        - mem_size: { in_range: [ 4 GB, 8 GB ] }
                        - disk_size: { in_range: [ 40 GB, 100GB ] }
                  - os:
                     properties:
                        - architecture: { valid_values: [ x86_64, i386 ] }
                        - type: { equal: linux }
                        - distribution: { equal: ubuntu }
                  - resource:
                     properties:
                        - type: { equal: cloud }
                  - sensors:
                     properties:
                        - camera: { equal: true }

   # Multimedia manager node selection
   processing_node_fragments_MultimediaManager:
      description: A TOSCA description of a node
      derived_from: prestocloud.nodes.agent.faas
      requirements:
         - host:
            capability: tosca.capabilities.Container
            node: prestocloud.nodes.compute
            relationship: tosca.relationships.HostedOn
            occurrences: [ 1,10 ]
            node_filter:
               capabilities:
                  - host:
                     properties:
                        - num_cpus: { in_range: [ 2, 4 ] }
                        - mem_size: { in_range: [ 4 GB, 8 GB ] }
                        - disk_size: { in_range: [ 100 GB, 500 GB ] }
                  - os:
                     properties:
                        - architecture: { valid_values: [ x86_64, i386 ] }
                        - type: { equal: linux }
                        - distribution: { equal: ubuntu }
                  - resource:
                     properties:
                        - type: { equal: cloud }

   # Requirements for Multimedia manager's load balancer
   load_balancing_MultimediaManager_type:
      description: Hosting requirements for the multimedia manager's load balancer
      derived_from: prestocloud.nodes.loadBalancer.faas
      requirements:
         - host:
            capability: tosca.capabilities.Container
            node: prestocloud.nodes.compute
            relationship: tosca.relationships.HostedOn
            occurrences: [ 1, 1 ]
            node_filter:
               capabilities:
                  - host:
                     properties:
                        - num_cpus: { in_range: [ 1, 2 ] }
                        - mem_size: { in_range: [ 2 GB, 4 GB ] }
                        - disk_size: { in_range: [ 20 GB, 40 GB ] }
                  - resource:
                     properties:
                        - type: { equal: cloud }

   # Video transcoder node selection
   processing_node_fragments_VideoTranscoder:
      description: A TOSCA description of a node
      derived_from: prestocloud.nodes.agent.faas
      requirements:
         - host:
            capability: tosca.capabilities.Container
            node: prestocloud.nodes.compute
            relationship: tosca.relationships.HostedOn
            occurrences: [ 1,10 ]
            node_filter:
               capabilities:
                  - host:
                     properties:
                        - num_cpus: { in_range: [ 2, 4 ] }
                        - mem_size: { in_range: [ 4 GB, 8 GB ] }
                        - disk_size: { in_range: [ 40 GB, 100 GB ] }
                  - os:
                     properties:
                        - architecture: { valid_values: [ x86_64, i386 ] }
                        - type: { equal: linux }
                        - distribution: { equal: ubuntu }
                  - resource:
                     properties:
                        - type: { equal: cloud }
                  - sensors:
                     properties:
                        - camera: { equal: true }

   # Requirements for Video transcoder's load balancer
   load_balancing_VideoTranscoder_type:
      description: Hosting requirements for the multimedia manager's load balancer
      derived_from: prestocloud.nodes.loadBalancer.faas
      requirements:
         - host:
            capability: tosca.capabilities.Container
            node: prestocloud.nodes.compute
            relationship: tosca.relationships.HostedOn
            occurrences: [ 1, 1 ]
            node_filter:
               capabilities:
                  - host:
                     properties:
                        - num_cpus: { in_range: [ 1, 2 ] }
                        - mem_size: { in_range: [ 2 GB, 4 GB ] }
                        - disk_size: { in_range: [ 20 GB, 40 GB ] }
                  - resource:
                     properties:
                        - type: { equal: cloud }

   # Percussion detector node selection
   processing_node_fragments_PercussionDetector:
      description: A TOSCA description of a node
      derived_from: prestocloud.nodes.agent.faas
      requirements:
         - host:
            capability: tosca.capabilities.Container
            node: prestocloud.nodes.compute
            relationship: tosca.relationships.HostedOn
            occurrences: [ 1,10 ]
            node_filter:
               capabilities:
                  - host:
                     properties:
                        - num_cpus: { in_range: [ 1, 2 ] }
                        - mem_size: { in_range: [ 2  GB, 4 GB ] }
                        - disk_size: { in_range: [ 20 GB, 40 GB ] }
                  - os:
                     properties:
                        - architecture: { valid_values: [ arm64, armel, armhf ] }
                        - type: { equal: linux }
                        - distribution: { equal: ubuntu }
                  - resource:
                     properties:
                        - type: { valid_values: [ edge ] }
                  - sensors:
                     properties:
                        - microphone: { equal: true }

   # Requirements for Percussion detector's load balancer
   load_balancing_PercussionDetector_type:
      description: Hosting requirements for the percussion detector's load balancer
      derived_from: prestocloud.nodes.loadBalancer.faas
      requirements:
         - host:
            capability: tosca.capabilities.Container
            node: prestocloud.nodes.compute
            relationship: tosca.relationships.HostedOn
            occurrences: [ 1, 1 ]
            node_filter:
               capabilities:
                  - host:
                     properties:
                        - num_cpus: { in_range: [ 1, 2 ] }
                        - mem_size: { in_range: [ 2 GB, 4 GB ] }
                        - disk_size: { in_range: [ 20 GB, 40 GB ] }
                  - resource:
                     properties:
                        - type: { valid_values: [ edge ] }

   # Video streamer node selection
   processing_node_fragments_VideoStreamer:
      description: A TOSCA description of a node
      derived_from: prestocloud.nodes.agent.faas
      requirements:
         - host:
            capability: tosca.capabilities.Container
            node: prestocloud.nodes.compute
            relationship: tosca.relationships.HostedOn
            occurrences: [ 3,10 ]
            node_filter:
               capabilities:
                  - host:
                     properties:
                        - num_cpus: { in_range: [ 1, 2 ] }
                        - mem_size: { in_range: [ 2 GB, 4 GB ] }
                        - disk_size: { in_range: [ 20 GB, 40 GB ] }
                  - os:
                     properties:
                        - architecture: { valid_values: [ arm64, armel, armhf ] }
                        - type: { equal: linux }
                        - distribution: { equal: ubuntu }
                  - resource:
                     properties:
                        - type: { valid_values: [ edge ] }
                  - sensors:
                     properties:
                        - camera: { equal: true }

   # Requirements for Video captor's load balancer
   load_balancing_VideoStreamer_type:
      description: Hosting requirements for the video streamer's load balancer
      derived_from: prestocloud.nodes.loadBalancer.faas
      requirements:
         - host:
            capability: tosca.capabilities.Container
            node: prestocloud.nodes.compute
            relationship: tosca.relationships.HostedOn
            occurrences: [ 1, 1 ]
            node_filter:
               capabilities:
                  - host:
                     properties:
                        - num_cpus: { in_range: [ 1, 2 ] }
                        - mem_size: { in_range: [ 2 GB, 4 GB ] }
                        - disk_size: { in_range: [ 20 GB, 40 GB ] }
                  - resource:
                     properties:
                        - type: { valid_values: [ edge ] }

topology_template:

   inputs:
      ssh_pub_key1:
         type: string
         description: <
            An SSH public key specified as input. If empty, the orchestrator must be able to retrieve it itself from its name.
      ssh_priv_key1:
         type: string
         description: <
            Reference an SSH private key. It may be pass as input only if the type level TOSCA remains private.
            The orchestrator must be able to retrieve it from its name (usually stored in a keyvault).

   node_templates:

      # Proxy used by both audio captor and face detector (fragments with 1 occurence)
      proxying_some_fragments:
         type: proxying_fragments_type

      # Audio captor
      deployment_node_fragments_AudioCaptor:
         type: processing_node_fragments_AudioCaptor
         properties:
            ssh_pub_key: { get_input: ssh_pub_key1 }

      fragments_AudioCaptor:
         type: prestocloud.nodes.fragment.faas
         properties:
            id: 0
            name: fragments.AudioCaptor
            onloadable: true
            docker:
              image: "lambda_proxy_app/main_app:1.2.2"
              registry: "nexus:39580"
              variables:
                SERVER_PORT: "9980"
                SUM_URL: "@GwdMGW4gbn"
                MULTIPLICATION_PORT: "9910"
                DIVISION_PORT: "9930"
                DIVISION_IPV6ENABLED: "false"
                MULTIPLICATION_URL: "@GwdMGW4gbn"
                DIVISION_URL: "@GwdMGW4gbn"
                SUM_PORT: "9920"
              ports:
                - target: 9980
                  published: 9980
                  protocol: TCP
                  vna: VNA0
         requirements:
            - execute: deployment_node_fragments_AudioCaptor
            - proxy: proxying_some_fragments

      # Face detector
      deployment_node_fragments_FaceDetector:
         type: processing_node_fragments_FaceDetector

      fragments_FaceDetector:
         type: prestocloud.nodes.fragment.faas
         properties:
            id: 1
            name: fragments.FaceDetector
            onloadable: false
         requirements:
            - execute: deployment_node_fragments_FaceDetector
            - proxy: proxying_some_fragments

      # Multimedia manager
      load_balancing_MultimediaManager:
         type: load_balancing_MultimediaManager_type

      deployment_node_fragments_MultimediaManager:
         type: processing_node_fragments_MultimediaManager

      fragments_MultimediaManager:
         type: prestocloud.nodes.fragment.faas
         properties:
            id: 2
            name: fragments.MultimediaManager
            onloadable: false
         requirements:
            - execute: deployment_node_fragments_MultimediaManager
            - balance_load: load_balancing_MultimediaManager

      # Video transcoder
      load_balancing_VideoTranscoder:
         type: load_balancing_VideoTranscoder_type

      deployment_node_fragments_VideoTranscoder:
         type: processing_node_fragments_VideoTranscoder

      fragments_VideoTranscoder:
         type: prestocloud.nodes.fragment.faas
         properties:
            id: 3
            name: fragments.VideoTranscoder
            onloadable: false
         requirements:
            - execute: deployment_node_fragments_VideoTranscoder
            - balance_load: load_balancing_VideoTranscoder

      # Percussion detector
      load_balancing_PercussionDetector:
         type: load_balancing_PercussionDetector_type

      deployment_node_fragments_PercussionDetector:
         type: processing_node_fragments_PercussionDetector

      fragments_PercussionDetector:
         type: prestocloud.nodes.fragment.faas
         properties:
            id: 4
            name: fragments.PercussionDetector
            onloadable: true
         requirements:
            - execute: deployment_node_fragments_PercussionDetector
            - balance_load: load_balancing_PercussionDetector

      # Video streamer
      load_balancing_VideoStreamer:
         type: load_balancing_VideoStreamer_type

      deployment_node_fragments_VideoStreamer:
         type: processing_node_fragments_VideoStreamer

      fragments_VideoStreamer:
         type: prestocloud.nodes.fragment.faas
         properties:
            id: 5
            name: fragments.VideoStreamer
            onloadable: true
         requirements:
            - execute: deployment_node_fragments_VideoStreamer
            - balance_load: load_balancing_VideoStreamer
